<!--
***********************************************************************************************
Microsoft.NET.ComposeCache.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
          created a backup copy.  Incorrect changes to this file will make it
          impossible to load or build your projects from the command-line or the IDE.

Copyright (c) .NET Foundation. All rights reserved. 
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--
    ============================================================
                                        ComposeCache
 
    The main cache entry point.
    ============================================================
    -->
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <Target Name="ComposeCache"
          DependsOnTargets="_InitializeBasicProps;
                            PrepareForComposeCache;
                            PrepOptimizer;
                            CacheWorkerMain;
                            CacheFinalizer;"/>


  <!--
    ============================================================
                                        CacheWorkerMain

   Spins of the compose mappers
    ============================================================
    -->

  <Target Name="CacheWorkerMain">
    
    <CreateItem Include="$(AdditionalProjects)">
      <Output ItemName="_AllProjects" TaskParameter="Include" />
    </CreateItem>
    
    <ItemGroup>
      <_AllProjects Include ="$(MSBuildProjectFullPath)"/>
    </ItemGroup>
    <MSBuild Projects="%(_AllProjects.Identity)"
                 Targets="CacheWorkerMapper"
                 Properties="ComposeWorkingDir=$(ComposeWorkingDir);
                             PublishDir=$(PublishDir);
                             TargetFramework=$(_TFM);
                             _JitPath=$(_JitPath);
                             _Crossgen=$(_Crossgen);
                             SkipUnchangedFiles=$(SkipUnchangedFiles);
                             PreserveCacheLayout=$(PreserveCacheLayout)"
                  ContinueOnError="WarnAndContinue"  />
   </Target>
  <!--
    ============================================================
                                        CacheWorkerMapper

   Spins of the compose mappers
    ============================================================
    -->

  <Target Name="CacheWorkerMapper">
   
    <ItemGroup>
      <PackageToRestore Include ="@(PackageReference)" Condition="'%(PackageReference.IsImplicitlyDefined)' != 'true'"/>
    </ItemGroup>
    
    <MSBuild Projects="$(MSBuildProjectFullPath)"
                 Targets="CacheWorker"
                 Properties="_RPackageName=%(PackageToRestore.Identity);
                             _RPackageVersion=%(PackageToRestore.Version);
                             ComposeWorkingDir=$(ComposeWorkingDir);
                             PublishDir=$(PublishDir);
                             TargetFramework=$(TargetFramework);
                             _JitPath=$(_JitPath);
                             _Crossgen=$(_Crossgen);
                             SkipUnchangedFiles=$(SkipUnchangedFiles);
                             PreserveCacheLayout=$(PreserveCacheLayout)"
                  ContinueOnError="WarnAndContinue"
             />
  </Target>
  
  <!--TODO - if $(CacheWorkerWorkingDir) exists some other worker is doing the job, Dedupe the root of a restore graph-->
  <Target Name="CacheWorker" 
          DependsOnTargets="_InitializeBasicProps;
                            RestoreForComposeCache;
                            ComputeAndCopyFilesToCacheDirectory;"/>
  
  <!--
    ============================================================
                                        CacheFinalizer

   Cleansup and produces artifacts after Completion of cache
    ============================================================
    -->
  
  <UsingTask TaskName="GetListofResolvedPackages" AssemblyFile="$(MicrosoftNETBuildTasksAssembly)" />
  <Target Name="CacheFinalizer">
    
    <Message Text="Files were composed in $(PublishDir)"
                 Importance="high"/>

    <GetListofResolvedPackages>
    <Output TaskParameter="PackagesResolved" ItemName="ListOfPackages" />
    </GetListofResolvedPackages>

    <ItemGroup>
      <ListOfPackageReference Include="@(ListOfPackages -> '%20%20%20%20%20&lt;PackageReference Include=&quot;%(Identity)&quot;  Version =&quot;%(Version)&quot;/&gt;')"/>
    </ItemGroup>
    <PropertyGroup>
     <_CacheArtifactContent>
      <![CDATA[
<Project Sdk="Microsoft.NET.Sdk" ToolsVersion="$(MSBuildToolsVersion)">
  <ItemGroup>
@(ListOfPackageReference)
  </ItemGroup>
</Project>    
]]>
       </_CacheArtifactContent>
      </PropertyGroup>
    <WriteLinesToFile
             File="$(CacheArtifactXml)"
             Lines="$(_CacheArtifactContent)"
             Overwrite="true" />
    
    <RemoveDir
        Condition="'$(PreserveComposeWorkingDir)' != 'true'"
        Directories="$(ComposeWorkingDir)" />
  </Target>

  <Target Name="_InitializeBasicProps">
    <PropertyGroup>
      <PathSeparator>$([System.IO.Path]::PathSeparator)</PathSeparator>
      <DirectorySeparatorChar>$([System.IO.Path]::DirectorySeparatorChar)</DirectorySeparatorChar>
      <TEMP Condition="'$(TEMP)' == ''">$([System.IO.Path]::GetTempPath())</TEMP>
    </PropertyGroup>
  </Target>
  <!--
    ============================================================
                                        PrepareForComposeCache

    Prepare the prerequisites for ComposeCache.
    ============================================================
    -->
  <Target Name="PrepareForComposeCache">

    <PropertyGroup>
      <PreserveCacheLayout Condition="'$(PreserveCacheLayout)' == ''">true</PreserveCacheLayout>
      <SkipOptimization Condition="'$(RuntimeIdentifier)' == ''">true</SkipOptimization>
      <_TFM Condition="'$(_TFM)' == ''">$(TargetFramework)</_TFM>
      <SkipUnchangedFiles Condition="'$(SkipUnchangedFiles)' == ''">true</SkipUnchangedFiles>
    </PropertyGroup>

    <NETSdkError Condition="'$(RuntimeIdentifier)' =='' and '$(_PureManagedAssets)' == ''"
                 ResourceName="RuntimeIdentifierMustBeSetForNETFramework"/>

    <NETSdkError Condition="'$(_TFM)' ==''"
                 ResourceName="AtLeastOneTargetFrameworkMustBeSpecified"/>
      
    <PropertyGroup>
      <DefaultComposeDir>$(HOME)</DefaultComposeDir>
      <DefaultComposeDir Condition="$(OS.ToUpper().Contains('WINDOWS'))">$(USERPROFILE)</DefaultComposeDir>
      <DefaultComposeDir>$([System.IO.Path]::Combine($(DefaultComposeDir), '.dotnet', $(PlatformTarget), 'packages'))</DefaultComposeDir>
      <ComposeDir Condition="'$(ComposeDir)' != '' and '$(DoNotDecorateComposeDir)' != 'true'">$([System.IO.Path]::Combine($(ComposeDir), $(PlatformTarget)))</ComposeDir>
      <ComposeDir Condition="'$(ComposeDir)' == ''">$(DefaultComposeDir)</ComposeDir>
      <ComposeDir Condition="'$(DoNotDecorateComposeDir)' != 'true'">$([System.IO.Path]::Combine($(ComposeDir), $(_TFM)))</ComposeDir>
      <CacheArtifactXml>$([System.IO.Path]::Combine($(ComposeDir),"artifact.xml"))</CacheArtifactXml>
      <PublishDir>$([System.IO.Path]::GetFullPath($(ComposeDir)))</PublishDir>
      <_RandomFileName>$([System.IO.Path]::GetRandomFileName())</_RandomFileName>
      <ComposeWorkingDir Condition="'$(ComposeWorkingDir)' == ''">$([System.IO.Path]::Combine($(TEMP), $(_RandomFileName)))</ComposeWorkingDir>
      <ComposeWorkingDir>$([System.IO.Path]::GetFullPath($(ComposeWorkingDir)))</ComposeWorkingDir>
      <!-- Ensure any PublishDir has a trailing slash, so it can be concatenated -->
      <PublishDir Condition="!HasTrailingSlash('$(PublishDir)')">$(PublishDir)\</PublishDir>
    </PropertyGroup>


    <NETSdkError Condition="Exists($(ComposeWorkingDir))"
                 ResourceName="FolderAlreadyExists"
                 FormatArguments="$(ComposeWorkingDir)" />


    <MakeDir Directories="$(PublishDir)" />

  </Target>

  <Target Name="PrepforRestoreForComposeCache">

    <PropertyGroup>
      <_RPackageVersion>$(_RPackageVersion.Replace('*','-'))</_RPackageVersion>
      <CacheWorkerWorkingDir>$([System.IO.Path]::Combine($(ComposeWorkingDir),"$(_RPackageName)_$(_RPackageVersion)"))</CacheWorkerWorkingDir>
      <_PackageProjFile>$([System.IO.Path]::Combine($(CacheWorkerWorkingDir), "Package.csproj"))</_PackageProjFile>
      <ProjectAssetsFile>$(CacheWorkerWorkingDir)\project.assets.json</ProjectAssetsFile>
      <_PackageProjContent>
        <![CDATA[
<Project Sdk="Microsoft.NET.Sdk" ToolsVersion="$(MSBuildToolsVersion)">
  <ItemGroup>
    <PackageReference Include="$(_RPackageName)"  Version ="$(_RPackageVersion)"/>
  </ItemGroup>
</Project>    
]]>
      </_PackageProjContent>
    </PropertyGroup>
    
  </Target>
  <!--
    ============================================================
                                        RestoreForComposeCache

    Restores the package
    ============================================================
    -->
  <Target Name="RestoreForComposeCache"
          DependsOnTargets="PrepforRestoreForComposeCache;">

    <Error
           Text=" Redundant root package specified"
           Code="0"
           Condition="Exists($(CacheWorkerWorkingDir))" />
    
    <MakeDir Directories="$(CacheWorkerWorkingDir)" />
    
    <!-- Create a Project to Restore Package -->
    <WriteLinesToFile
            File="$(_PackageProjFile)"
            Lines="$(_PackageProjContent)"
            Overwrite="true" />
    
    <MSBuild Projects="$(_PackageProjFile)"
                 Targets="Restore"
                 Properties="RestoreGraphProjectInput=$(_PackageProjFile);
                             DisableImplicitFrameworkReferences=true;
                             RestoreOutputPath=$(CacheWorkerWorkingDir);
                             TargetFramework=$(TargetFramework);"/>
  </Target>


  <!--
    ============================================================
                                        ComputeAndCopyFilesToCacheDirectory

    Computes the list of all files to copy to the publish directory and then publishes them.
    ============================================================
    -->
  <Target Name="ComputeAndCopyFilesToCacheDirectory"
          DependsOnTargets="ComputeFilesToCache;
                            CopyFilesToCacheDirectory" />

  <!--
    ============================================================
                                        CopyFilesToCacheDirectory

    Copy all build outputs, satellites and other necessary files to the publish directory.
    ============================================================
    -->
  <Target Name="CopyFilesToCacheDirectory"
          DependsOnTargets="_CopyResolvedOptimizedFiles;
                            _CopyResolvedUnOptimizedFiles"/>

  <!--
    ============================================================
                                        _CopyResolvedOptimizedFiles

    Copy _CopyResolvedOptimizedFiles items to the publish directory.
    ============================================================
    -->
  <Target Name="_CopyResolvedOptimizedFiles"
          DependsOnTargets="_ComputeResolvedFilesToCacheTypes;"
          Inputs="@(_ManagedResolvedFileToPublish)"
          Outputs="@(_ManagedResolvedFileToPublish->'$(PublishDir)%(RecursiveDir)%(Fileame)%(Extension)')">

    <Copy SourceFiles = "@(_ManagedResolvedFileToPublish)"
          DestinationFiles="$(PublishDir)%(RecursiveDir)%(Filename)%(Extension)"
          Condition ="!Exists($(PublishDir)%(RecursiveDir)%(Filename)%(Extension))"
          OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
          Retries="$(CopyRetryCount)"
          RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)">

      <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>

    </Copy>

  </Target>

  <!--
    ============================================================
                                        _CopyResolvedUnOptimizedFiles

    Copy _UnOptimizedResolvedFileToPublish items to the publish directory.
    ============================================================
    -->
  <Target Name="_CopyResolvedUnOptimizedFiles"
          DependsOnTargets="_ComputeResolvedFilesToCacheTypes;
                            _RunOptimizer">

    <Copy SourceFiles = "@(_UnOptimizedResolvedFileToPublish)"
          DestinationFiles="$(PublishDir)%(_UnOptimizedResolvedFileToPublish.DestinationSubPath)"
          OverwriteReadOnlyFiles="$(OverwriteReadOnlyFiles)"
          Retries="$(CopyRetryCount)"
          RetryDelayMilliseconds="$(CopyRetryDelayMilliseconds)"
          SkipUnchangedFiles="$(SkipUnchangedFiles)">

      <Output TaskParameter="DestinationFiles" ItemName="FileWrites"/>

    </Copy>

  </Target>

  <!--
    ============================================================
                                        _ComputeResolvedFilesToCacheTypes
    ============================================================
    -->
  <Target Name="_ComputeResolvedFilesToCacheTypes"
           DependsOnTargets="_GetResolvedFilesToCache;_SplitResolvedFiles;" />

  <!--
    ============================================================
                                        _SplitResolvedFiles

    Splits ResolvedFileToPublish items into 'managed' and 'unmanaged' buckets.
    ============================================================
    -->
  <Target Name="_SplitResolvedFiles"
           Condition="$(SkipOptimization) !='true' "
           DependsOnTargets="_GetResolvedFilesToCache">
    <ItemGroup>
      <_ManagedResolvedFileToPublishCandidates Include="@(ResolvedFileToPublish)"
                                             Condition="'%(ResolvedFileToPublish.AssetType)'=='runtime'" />

      <_UnOptimizedResolvedFileToPublish Include="@(ResolvedFileToPublish)"
                                     Condition="'%(ResolvedFileToPublish.AssetType)'!='runtime'" />
    </ItemGroup>

    <PropertyGroup>
      <SkipOptimization Condition="'@(_ManagedResolvedFileToPublishCandidates)'==''">true</SkipOptimization>
    </PropertyGroup>
    
  </Target>

  <!--
    ============================================================
                                        _GetResolvedFilesToCache

   
    ============================================================
    -->
  <Target Name="_GetResolvedFilesToCache"
           Condition="$(SkipOptimization) == 'true' ">
    <ItemGroup>
            <_UnOptimizedResolvedFileToPublish Include="@(ResolvedFileToPublish)" />
    </ItemGroup>
  </Target>

  <!--
    ============================================================
                                        ComputeFilesToCache

    Gathers all the files that need to be copied to the publish directory.
    ============================================================
    -->
  <Target Name="ComputeFilesToCache"
          DependsOnTargets="_ComputeNetPublishAssets;
                            _ComputeCopyToPublishDirectoryItems">

    <PropertyGroup>
      <CopyBuildOutputToPublishDirectory Condition="'$(CopyBuildOutputToPublishDirectory)'==''">true</CopyBuildOutputToPublishDirectory>
      <CopyOutputSymbolsToPublishDirectory Condition="'$(CopyOutputSymbolsToPublishDirectory)'==''">true</CopyOutputSymbolsToPublishDirectory>
    </PropertyGroup>

    <ItemGroup>

      <!-- Copy all the assemblies -->
      <ResolvedFileToPublish Include="@(ResolvedAssembliesToPublish)">
      </ResolvedFileToPublish>
    </ItemGroup>

  </Target>

</Project>
